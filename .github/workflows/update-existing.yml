name: Weekly Refresh Existing Races

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - run: pip install anthropic requests pyyaml python-frontmatter
      
      - name: Find races needing update
        id: find-races
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          
          # Load database
          with open("db/gravel_races_full_database.json") as f:
              db = json.load(f)
          
          # Find races with briefs older than 30 days
          races_to_update = []
          briefs_dir = "briefs"
          
          if os.path.exists(briefs_dir):
              for file in os.listdir(briefs_dir):
                  if file.endswith("-brief.md"):
                      filepath = os.path.join(briefs_dir, file)
                      mtime = os.path.getmtime(filepath)
                      age_days = (datetime.now().timestamp() - mtime) / 86400
                      
                      if age_days > 30:
                          race_name = file.replace("-brief.md", "").replace("-", " ").title()
                          races_to_update.append({
                              "race_name": race_name,
                              "folder": file.replace("-brief.md", "")
                          })
          
          # Limit to 10 per run
          races_to_update = races_to_update[:10]
          
          matrix = {"include": races_to_update}
          print(f"::set-output name=matrix::{json.dumps(matrix)}")
          print(f"Found {len(races_to_update)} races to refresh")
          EOF
      
      - name: Refresh races
        strategy:
          matrix: ${{ fromJson(steps.find-races.outputs.matrix) }}
          max-parallel: 2
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Refreshing: ${{ matrix.race_name }}"
          
          python scripts/research.py \
            --race "${{ matrix.race_name }}" \
            --folder "${{ matrix.folder }}"
          
          python scripts/synthesize.py \
            --input "research-dumps/${{ matrix.folder }}-raw.md" \
            --output "briefs/${{ matrix.folder }}-brief.md"
          
          python scripts/generate_json.py \
            --input "briefs/${{ matrix.folder }}-brief.md" \
            --output "landing-pages/${{ matrix.folder }}.json"
      
      - name: Commit updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Weekly refresh: Updated race briefs" || echo "No changes"
          git push || true

