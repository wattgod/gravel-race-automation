{% extends "base.html" %}

{% block title %}Analytics — Gravel God Mission Control{% endblock %}

{% block content %}
<div class="mc-page-header mc-page-header--with-actions">
    <div>
        <span class="mc-page-header__kicker">Marketing</span>
        <h1 class="mc-page-header__title">Analytics</h1>
        <p class="mc-page-header__desc">GA4 traffic, conversions, and top pages. Cached 4 hours.</p>
    </div>
    <div class="mc-page-header__actions">
        <form hx-post="/analytics/refresh" hx-target="#refresh-result" hx-swap="innerHTML">
            <button type="submit" class="gg-btn gg-btn--ghost">Refresh Data</button>
        </form>
    </div>
</div>

<div id="refresh-result" class="mc-mb-md"></div>

<!-- Summary Stats -->
<div class="gg-stat-grid">
    <div class="gg-stat-card">
        <div class="gg-stat-card__value">{{ "{:,}".format(total_sessions) }}</div>
        <div class="gg-stat-card__label">Sessions (90 days)</div>
    </div>
    <div class="gg-stat-card">
        <div class="gg-stat-card__value">{{ "{:,}".format(total_pageviews) }}</div>
        <div class="gg-stat-card__label">Top 20 Pageviews (30d)</div>
    </div>
    <div class="gg-stat-card">
        <div class="gg-stat-card__value mc-text-teal">{{ "{:,}".format(total_conversions) }}</div>
        <div class="gg-stat-card__label">Conversions (30d)</div>
    </div>
    <div class="gg-stat-card">
        <div class="gg-stat-card__value">{{ sources|length }}</div>
        <div class="gg-stat-card__label">Traffic Channels</div>
    </div>
</div>

<!-- Sessions Trend -->
{% if daily %}
<div class="mc-card mc-mt-lg">
    <div class="mc-card__header">
        <h3 class="mc-card__title">Sessions — 90 Day Trend</h3>
    </div>
    <div class="mc-card__body">
        <canvas id="sessionsChart" height="200"></canvas>
    </div>
</div>
{% endif %}

<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--gg-spacing-lg)" class="mc-mt-lg">
    <!-- Traffic Sources -->
    <div class="mc-card">
        <div class="mc-card__header">
            <h3 class="mc-card__title">Traffic Sources (30 days)</h3>
        </div>
        <div class="mc-card__body">
            {% if sources %}
            {% set max_sessions = sources[0].sessions if sources else 1 %}
            {% for src in sources %}
            <div class="mc-mb-sm">
                <div class="mc-flex-between" style="font-size:var(--gg-font-size-xs)">
                    <span>{{ src.channel }}</span>
                    <span class="mc-text-mono mc-text-muted">{{ "{:,}".format(src.sessions) }}</span>
                </div>
                <div style="background:var(--gg-color-sand);height:4px;margin-top:4px">
                    <div style="height:100%;background:var(--gg-color-teal);width:{{ (src.sessions / max_sessions * 100)|int }}%"></div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="mc-text-muted" style="font-size:var(--gg-font-size-sm)">No traffic data available. Check GA4 credentials.</p>
            {% endif %}
        </div>
    </div>

    <!-- Conversion Events -->
    <div class="mc-card">
        <div class="mc-card__header">
            <h3 class="mc-card__title">Conversion Events (30 days)</h3>
        </div>
        <div class="mc-card__body">
            {% if conversions %}
            <table class="gg-table gg-table--compact">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th class="mc-text-right">Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ev in conversions %}
                    <tr>
                        <td class="mc-text-mono" style="font-size:var(--gg-font-size-2xs)">{{ ev.event }}</td>
                        <td class="mc-text-right mc-text-teal" style="font-weight:600">{{ "{:,}".format(ev.count) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="mc-text-muted" style="font-size:var(--gg-font-size-sm)">No conversion data available.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Top Pages -->
<div class="mc-card mc-mt-lg">
    <div class="mc-card__header">
        <h3 class="mc-card__title">Top 20 Pages (30 days)</h3>
    </div>
    <div class="mc-card__body mc-card__body--flush">
        {% if top_pages %}
        <table class="gg-table gg-table--striped gg-table--compact">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Page</th>
                    <th class="mc-text-right">Pageviews</th>
                    <th class="mc-text-right">Sessions</th>
                </tr>
            </thead>
            <tbody>
                {% for page in top_pages %}
                <tr>
                    <td class="mc-text-muted">{{ loop.index }}</td>
                    <td class="mc-text-mono" style="font-size:var(--gg-font-size-2xs)">
                        <a href="https://gravelgodcycling.com{{ page.path }}" target="_blank">{{ page.path }}</a>
                    </td>
                    <td class="mc-text-right" style="font-weight:600">{{ "{:,}".format(page.pageviews) }}</td>
                    <td class="mc-text-right mc-text-muted">{{ "{:,}".format(page.sessions) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="padding:var(--gg-spacing-lg);text-align:center">
            <p class="mc-text-muted">No page data available. Check GA4 credentials.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if daily %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const ctx = document.getElementById('sessionsChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for d in daily %}'{{ d.date[5:] }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Sessions',
            data: [{% for d in daily %}{{ d.sessions }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#1A8A82',
            backgroundColor: 'rgba(26, 138, 130, 0.08)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2,
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
        },
        scales: {
            x: {
                grid: { display: false },
                ticks: {
                    maxTicksLimit: 10,
                    font: { family: "'Sometype Mono', monospace", size: 10 },
                    color: '#8c7568',
                }
            },
            y: {
                grid: { color: 'rgba(212, 197, 185, 0.5)' },
                ticks: {
                    font: { family: "'Sometype Mono', monospace", size: 10 },
                    color: '#8c7568',
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
