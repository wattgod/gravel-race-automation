<!--
  Gravel God Race Search — Embeddable in WordPress via shortcode [gravel_search].

  Loads race-index.json, renders filterable race cards with:
  - Tier-grouped collapsible sections (T1/T2 open, T3/T4 collapsed)
  - "Find Your Race" questionnaire with 7 sliders → match % ranking
  - Distance, elevation, tier, region, month filters
  - Mini radar chart SVGs + score breakdown dots
  - Links to race profile pages

  Self-contained: no React, no build step, vanilla JS + CSS.
-->
<div id="gg-race-search">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sometype+Mono:wght@400;700&display=swap');

    /* All selectors prefixed with #gg-race-search to beat WP theme specificity */
    #gg-race-search {
      font-family: 'Sometype Mono', monospace !important;
      max-width: 1200px;
      margin: 0 auto;
      color: #000 !important;
    }
    #gg-race-search *, #gg-race-search *::before, #gg-race-search *::after {
      border-radius: 0 !important;
      box-shadow: none !important;
      font-family: 'Sometype Mono', monospace !important;
    }

    /* ── Questionnaire ── */
    #gg-race-search .gg-questionnaire {
      margin-bottom: 24px;
      border: 3px solid #000;
    }
    #gg-race-search .gg-questionnaire-header {
      background: #59473c !important;
      color: #fff !important;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    #gg-race-search .gg-questionnaire-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #fff !important;
    }
    #gg-race-search .gg-questionnaire-toggle {
      font-size: 18px;
      color: #fff !important;
      transition: transform 0.2s;
    }
    #gg-race-search .gg-questionnaire-toggle.collapsed { transform: rotate(-90deg); }
    #gg-race-search .gg-questionnaire-body {
      padding: 20px;
      background: #fff !important;
      border-top: 2px solid #000;
    }
    #gg-race-search .gg-questionnaire-body.collapsed { display: none; }
    #gg-race-search .gg-slider-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 32px;
    }
    #gg-race-search .gg-slider-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #gg-race-search .gg-slider-label {
      font-size: 12px;
      font-weight: 700;
      color: #000 !important;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #gg-race-search .gg-slider-endpoints {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #666 !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #gg-race-search .gg-slider-row input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: #ccc;
      outline: none;
      cursor: pointer;
      margin: 8px 0;
    }
    #gg-race-search .gg-slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      background: #59473c;
      border: 2px solid #000;
      cursor: pointer;
    }
    #gg-race-search .gg-slider-row input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      background: #59473c;
      border: 2px solid #000;
      border-radius: 0;
      cursor: pointer;
    }
    #gg-race-search .gg-slider-row input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: #ccc;
    }
    #gg-race-search .gg-slider-row input[type="range"]::-moz-range-track {
      height: 6px;
      background: #ccc;
    }
    #gg-race-search .gg-questionnaire-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      align-items: center;
    }
    #gg-race-search .gg-btn-match {
      padding: 10px 24px;
      background: #59473c !important;
      color: #fff !important;
      border: 3px solid #59473c !important;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      cursor: pointer;
    }
    #gg-race-search .gg-btn-match:hover { background: #8c7568 !important; border-color: #8c7568 !important; }
    #gg-race-search .gg-btn-reset {
      padding: 10px 24px;
      background: #fff !important;
      color: #59473c !important;
      border: 2px solid #59473c !important;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
    }
    #gg-race-search .gg-btn-reset:hover { background: #59473c !important; color: #fff !important; }
    #gg-race-search .gg-match-badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      background: #000 !important;
      color: #fff !important;
      border: 2px solid #000 !important;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ── Filters ── */
    #gg-race-search .gg-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: #fff !important;
      border: 2px solid #000;
    }
    #gg-race-search .gg-filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
    }
    #gg-race-search .gg-filter-group label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #000 !important;
    }
    #gg-race-search .gg-filter-group select,
    #gg-race-search .gg-filter-group input {
      padding: 6px 8px;
      border: 2px solid #000 !important;
      font-size: 13px;
      background: #fff !important;
      color: #000 !important;
    }
    #gg-race-search .gg-search-input {
      flex: 1;
      min-width: 200px;
    }
    #gg-race-search .gg-search-input input {
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
    }

    /* ── Results header ── */
    #gg-race-search .gg-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 12px;
      color: #000 !important;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #gg-race-search button.gg-sort-btn {
      background: #fff !important;
      color: #000 !important;
      border: 2px solid #000 !important;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #gg-race-search button.gg-sort-btn.active {
      background: #59473c !important;
      color: #fff !important;
      border-color: #59473c !important;
    }
    #gg-race-search button.gg-sort-btn:hover {
      background: #59473c !important;
      color: #fff !important;
      border-color: #59473c !important;
    }

    /* ── Tier sections ── */
    #gg-race-search .gg-tier-section {
      margin-bottom: 24px;
      border: 3px solid #000;
    }
    #gg-race-search .gg-tier-section-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      background: #fff !important;
      border-left: 6px solid #000;
    }
    #gg-race-search .gg-tier-section-header.tier-1 { border-left-color: #59473c !important; background: #59473c !important; color: #fff !important; }
    #gg-race-search .gg-tier-section-header.tier-1 h3 { color: #fff !important; }
    #gg-race-search .gg-tier-section-header.tier-1 .gg-tier-section-count { color: #c4b5ab !important; }
    #gg-race-search .gg-tier-section-header.tier-1 .gg-tier-section-chevron { color: #fff !important; }
    #gg-race-search .gg-tier-section-header.tier-2 { border-left-color: #8c7568 !important; }
    #gg-race-search .gg-tier-section-header.tier-3 { border-left-color: #999 !important; }
    #gg-race-search .gg-tier-section-header.tier-4 { border-left-color: #ccc !important; }
    #gg-race-search .gg-tier-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #gg-race-search .gg-tier-section-title h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #000 !important;
    }
    #gg-race-search .gg-tier-section-count {
      font-size: 11px;
      color: #666 !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #gg-race-search .gg-tier-section-desc {
      font-size: 11px; color: #8c7568; margin: 4px 0 0 0;
      line-height: 1.5; font-weight: 400;
      width: 100%; flex-basis: 100%;
    }
    #gg-race-search .gg-tier-section-header.tier-1 .gg-tier-section-desc { color: #c4b5ab; }
    #gg-race-search .gg-tier-section-chevron {
      font-size: 16px;
      color: #000 !important;
      transition: transform 0.2s;
    }
    #gg-race-search .gg-tier-section-chevron.collapsed { transform: rotate(-90deg); }
    #gg-race-search .gg-tier-section-body {
      padding: 16px;
      background: #fff !important;
      border-top: 2px solid #000;
    }
    #gg-race-search .gg-tier-section-body.collapsed { display: none; }

    /* ── Card grid ── */
    #gg-race-search .gg-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }
    #gg-race-search .gg-card {
      border: 2px solid #000 !important;
      padding: 16px;
      background: #fff !important;
    }
    #gg-race-search .gg-card:hover {
      background: #f5f5f5 !important;
    }
    #gg-race-search .gg-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    #gg-race-search a.gg-card-name,
    #gg-race-search span.gg-card-name {
      font-size: 15px;
      font-weight: 700;
      color: #000 !important;
      text-decoration: none !important;
      line-height: 1.2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #gg-race-search a.gg-card-name:hover { text-decoration: underline !important; color: #000 !important; }
    #gg-race-search span.gg-card-name.no-link { cursor: default; }
    #gg-race-search span.gg-card-name.no-link:hover { text-decoration: none !important; }
    #gg-race-search .gg-tier-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      white-space: nowrap;
      text-transform: uppercase;
      border: 2px solid #000 !important;
    }
    #gg-race-search .gg-tier-1 { background: #000 !important; color: #fff !important; }
    #gg-race-search .gg-tier-2 { background: #fff !important; color: #000 !important; border-color: #000 !important; }
    #gg-race-search .gg-tier-3 { background: #fff !important; color: #666 !important; border-color: #666 !important; }
    #gg-race-search .gg-tier-4 { background: #fff !important; color: #999 !important; border-color: #999 !important; }
    #gg-race-search .gg-card-meta {
      font-size: 12px;
      color: #666 !important;
      margin-bottom: 8px;
    }
    #gg-race-search .gg-card-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    #gg-race-search .gg-stat { display: flex; flex-direction: column; }
    #gg-race-search .gg-stat-val { font-weight: 700; font-size: 15px; color: #000 !important; }
    #gg-race-search .gg-stat-label { font-size: 10px; color: #666 !important; text-transform: uppercase; letter-spacing: 1px; }
    #gg-race-search .gg-card-tagline {
      font-size: 12px;
      color: #444 !important;
      font-style: italic;
      margin-top: 8px;
      line-height: 1.4;
    }

    /* ── Score bar + breakdown ── */
    #gg-race-search .gg-score-bar {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      position: relative;
    }
    #gg-race-search .gg-score-track {
      flex: 1;
      height: 6px;
      background: #ddd !important;
      border: 1px solid #000;
      overflow: hidden;
    }
    #gg-race-search .gg-score-fill {
      height: 100%;
      transition: width 0.3s;
    }
    #gg-race-search .gg-score-num {
      font-size: 13px;
      font-weight: 700;
      min-width: 28px;
      text-align: right;
      color: #000 !important;
    }
    #gg-race-search .gg-score-breakdown {
      display: none;
      margin-top: 8px;
      padding: 10px;
      background: #fff !important;
      border: 2px solid #000;
    }
    #gg-race-search .gg-score-breakdown.open { display: block; }
    #gg-race-search .gg-score-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 16px;
    }
    #gg-race-search .gg-score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      padding: 2px 0;
    }
    #gg-race-search .gg-score-row-label { color: #000 !important; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; }
    #gg-race-search .gg-score-row-dots { display: flex; gap: 3px; }
    #gg-race-search .gg-score-dot {
      width: 8px;
      height: 8px;
      background: #ddd !important;
      border: 1px solid #000;
    }
    #gg-race-search .gg-score-dot.filled { background: #000 !important; }
    #gg-race-search .gg-radar { margin-top: 8px; }

    /* ── Load more (per-tier) ── */
    #gg-race-search button.gg-load-more {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: #fff !important;
      color: #000 !important;
      border: 2px solid #000 !important;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
    }
    #gg-race-search button.gg-load-more:hover { background: #59473c !important; color: #fff !important; border-color: #59473c !important; }

    /* ── Active filter pills ── */
    #gg-race-search .gg-active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    #gg-race-search .gg-filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      background: #59473c !important;
      color: #fff !important;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid #59473c !important;
    }
    #gg-race-search .gg-filter-pill button {
      background: none !important;
      border: none !important;
      color: #fff !important;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      opacity: 0.7;
    }
    #gg-race-search .gg-filter-pill button:hover { opacity: 1; }
    #gg-race-search button.gg-clear-all {
      background: #fff !important;
      border: 2px solid #000 !important;
      color: #000 !important;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    #gg-race-search button.gg-clear-all:hover { background: #59473c !important; color: #fff !important; border-color: #59473c !important; }

    /* ── No results ── */
    #gg-race-search .gg-no-results {
      text-align: center;
      padding: 40px;
      color: #666 !important;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ── Mobile filter toggle ── */
    #gg-race-search button.gg-filter-toggle {
      display: none;
      width: 100%;
      padding: 10px;
      background: #fff !important;
      border: 2px solid #000 !important;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      margin-bottom: 12px;
      text-align: left;
      color: #000 !important;
    }
    #gg-race-search button.gg-filter-toggle::after { content: ' ▾'; float: right; }
    #gg-race-search button.gg-filter-toggle.open::after { content: ' ▴'; }

    /* ── Match mode banner ── */
    #gg-race-search .gg-match-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      margin-bottom: 16px;
      background: #59473c !important;
      color: #fff !important;
      border: 3px solid #59473c !important;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #gg-race-search .gg-match-banner button {
      padding: 6px 14px;
      background: #fff !important;
      color: #59473c !important;
      border: 2px solid #fff !important;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
    }
    #gg-race-search .gg-match-banner button:hover { background: #8c7568 !important; color: #fff !important; border-color: #8c7568 !important; }

    @media (max-width: 768px) {
      #gg-race-search .gg-grid { grid-template-columns: 1fr; }
      #gg-race-search button.gg-filter-toggle { display: block; }
      #gg-race-search .gg-filters { flex-direction: column; display: none; }
      #gg-race-search .gg-filters.open { display: flex; }
      #gg-race-search .gg-score-grid { grid-template-columns: 1fr; }
      #gg-race-search .gg-slider-grid { grid-template-columns: 1fr; }
      #gg-race-search .gg-questionnaire-header h3 { font-size: 13px; letter-spacing: 1px; }
      #gg-race-search .gg-questionnaire-body { padding: 14px; }
      #gg-race-search .gg-questionnaire-actions { flex-direction: column; align-items: stretch; }
      #gg-race-search .gg-btn-match, #gg-race-search .gg-btn-reset { text-align: center; }
      #gg-race-search .gg-results-header { flex-direction: column; gap: 8px; align-items: flex-start; }
      #gg-race-search .gg-tier-section-title h3 { font-size: 12px; letter-spacing: 1px; }
      #gg-race-search .gg-tier-section-header { padding: 10px 12px; }
      #gg-race-search .gg-tier-section-body { padding: 12px; }
      #gg-race-search .gg-card { padding: 12px; }
      #gg-race-search .gg-card-name { font-size: 13px; }
      #gg-race-search .gg-card-header { flex-direction: column; gap: 6px; }
      #gg-race-search .gg-match-banner { flex-direction: column; gap: 8px; text-align: center; }
    }
  </style>

  <!-- Questionnaire -->
  <div class="gg-questionnaire">
    <div class="gg-questionnaire-header" onclick="toggleQuestionnaire()">
      <h3>Find Your Perfect Race</h3>
      <span class="gg-questionnaire-toggle" id="gg-q-toggle">▾</span>
    </div>
    <div class="gg-questionnaire-body" id="gg-q-body">
      <div class="gg-slider-grid" id="gg-slider-grid"></div>
      <div class="gg-questionnaire-actions">
        <button class="gg-btn-match" onclick="runMatch()">Find My Races</button>
        <button class="gg-btn-reset" id="gg-btn-reset" style="display:none" onclick="resetMatch()">Back to Tiers</button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <button class="gg-filter-toggle" id="gg-filter-toggle" onclick="document.querySelector('.gg-filters').classList.toggle('open');this.classList.toggle('open')">Filters</button>
  <div class="gg-filters">
    <div class="gg-search-input">
      <label>Search</label>
      <input type="text" id="gg-search" placeholder="Race name or location...">
    </div>
    <div class="gg-filter-group">
      <label>Tier</label>
      <select id="gg-tier">
        <option value="">All Tiers</option>
        <option value="1">Tier 1</option>
        <option value="2">Tier 2</option>
        <option value="3">Tier 3</option>
      </select>
    </div>
    <div class="gg-filter-group">
      <label>Region</label>
      <select id="gg-region">
        <option value="">All Regions</option>
      </select>
    </div>
    <div class="gg-filter-group">
      <label>Distance</label>
      <select id="gg-distance">
        <option value="">Any Distance</option>
        <option value="0-50">Under 50 mi</option>
        <option value="50-100">50-100 mi</option>
        <option value="100-200">100-200 mi</option>
        <option value="200-999">200+ mi</option>
      </select>
    </div>
    <div class="gg-filter-group">
      <label>Month</label>
      <select id="gg-month">
        <option value="">Any Month</option>
      </select>
    </div>
    <div class="gg-filter-group">
      <label>Profile</label>
      <select id="gg-profile">
        <option value="">All</option>
        <option value="yes">Has Profile</option>
        <option value="no">No Profile</option>
      </select>
    </div>
  </div>

  <div class="gg-active-filters" id="gg-active-filters"></div>

  <div class="gg-results-header">
    <span id="gg-count"></span>
    <div>
      <button class="gg-sort-btn active" data-sort="score">Score</button>
      <button class="gg-sort-btn" data-sort="name">Name</button>
      <button class="gg-sort-btn" data-sort="distance">Distance</button>
    </div>
  </div>

  <div id="gg-tier-container"></div>

  <script>
    (function() {
      const DATA_URL = '/wp-content/uploads/race-index.json';
      const TIER_PAGE_SIZE = 20;

      let allRaces = [];
      let currentSort = 'score';
      let displayMode = 'tiers'; // 'tiers' or 'match'
      let matchScores = {};      // slug → match pct
      let tierVisibleCounts = { 1: TIER_PAGE_SIZE, 2: TIER_PAGE_SIZE, 3: TIER_PAGE_SIZE, 4: TIER_PAGE_SIZE };
      let tierCollapsed = { 1: false, 2: false, 3: true, 4: true };

      const TIER_NAMES = { 1: 'Elite', 2: 'Contender', 3: 'Solid', 4: 'Roster' };
      const TIER_DESCS = {
        1: 'The definitive gravel events. World-class fields, iconic courses, bucket-list status.',
        2: 'Established races with strong reputations and competitive fields. The next tier of must-do events.',
        3: 'Regional favorites and emerging races. Strong local scenes, genuine gravel character.',
        4: 'Up-and-coming races and local grinders. Grassroots gravel — small fields, raw vibes.'
      };
      const TIER_COLORS = { 1: '#c4421a', 2: '#d4830a', 3: '#888', 4: '#ccc' };

      const SLIDERS = [
        { key: 'distance',      label: 'Distance',      low: 'Quick Spin',       high: 'Ultra Endurance', mapping: [{ field: 'length', weight: 1.0 }] },
        { key: 'technicality',  label: 'Technicality',   low: 'Smooth Gravel',    high: 'Single Track',    mapping: [{ field: 'technicality', weight: 1.0 }] },
        { key: 'climbing',      label: 'Climbing',       low: 'Flat is Fast',     high: 'Mountain Goat',   mapping: [{ field: 'elevation', weight: 1.0 }] },
        { key: 'adventure',     label: 'Adventure',      low: 'Close to Town',    high: 'Deep Backcountry',mapping: [{ field: 'adventure', weight: 0.6 }, { field: 'logistics', weight: 0.4 }] },
        { key: 'competition',   label: 'Competition',    low: 'Just Finish',      high: 'Pro Field',       mapping: [{ field: 'field_depth', weight: 0.6 }, { field: 'race_quality', weight: 0.4 }] },
        { key: 'prestige',      label: 'Prestige',       low: 'Hidden Gem',       high: 'Bucket List',     mapping: [{ field: 'prestige', weight: 1.0 }] },
        { key: 'budget',        label: 'Budget',         low: 'All-In',           high: 'Budget Friendly', mapping: [{ field: 'value', weight: 0.6 }, { field: 'expenses', weight: 0.4, invert: true }] }
      ];

      // ── Init ──
      function init() {
        buildSliders();
        fetch(DATA_URL)
          .then(r => r.json())
          .then(data => {
            allRaces = data;
            populateFilterOptions();
            loadFromURL();
            render();
            bindEvents();
          })
          .catch(err => {
            document.getElementById('gg-tier-container').innerHTML =
              '<div class="gg-no-results">Failed to load race data. Check console.</div>';
            console.error('Race index load error:', err);
          });
      }

      // ── Questionnaire sliders ──
      function buildSliders() {
        const grid = document.getElementById('gg-slider-grid');
        grid.innerHTML = SLIDERS.map(s => `
          <div class="gg-slider-row">
            <span class="gg-slider-label">${s.label}</span>
            <input type="range" min="1" max="5" value="3" id="gg-q-${s.key}">
            <div class="gg-slider-endpoints">
              <span>${s.low}</span>
              <span>${s.high}</span>
            </div>
          </div>
        `).join('');
      }

      function getSliderValues() {
        const vals = {};
        SLIDERS.forEach(s => {
          vals[s.key] = parseInt(document.getElementById('gg-q-' + s.key).value);
        });
        return vals;
      }

      function computeMatchScore(race, sliderVals) {
        if (!race.scores) return 0;
        let weightedSqDiff = 0;
        let totalWeight = 0;
        SLIDERS.forEach(s => {
          const userVal = sliderVals[s.key];
          s.mapping.forEach(m => {
            let raceVal = race.scores[m.field] || 1;
            if (m.invert) raceVal = 6 - raceVal;
            const diff = userVal - raceVal;
            weightedSqDiff += m.weight * diff * diff;
            totalWeight += m.weight;
          });
        });
        const maxPossible = totalWeight * 16; // max squared diff per dimension = (5-1)^2 = 16
        return Math.round((1 - weightedSqDiff / maxPossible) * 100);
      }

      // ── Match mode ──
      function runMatch() {
        const vals = getSliderValues();
        matchScores = {};
        allRaces.forEach(r => {
          matchScores[r.slug] = computeMatchScore(r, vals);
        });
        displayMode = 'match';
        document.getElementById('gg-btn-reset').style.display = '';
        render();
        saveToURL();
      }
      window.runMatch = runMatch;

      function resetMatch() {
        displayMode = 'tiers';
        matchScores = {};
        document.getElementById('gg-btn-reset').style.display = 'none';
        tierVisibleCounts = { 1: TIER_PAGE_SIZE, 2: TIER_PAGE_SIZE, 3: TIER_PAGE_SIZE, 4: TIER_PAGE_SIZE };
        render();
        saveToURL();
      }
      window.resetMatch = resetMatch;

      // ── Questionnaire toggle ──
      function toggleQuestionnaire() {
        const body = document.getElementById('gg-q-body');
        const toggle = document.getElementById('gg-q-toggle');
        body.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');
      }
      window.toggleQuestionnaire = toggleQuestionnaire;

      // ── URL state ──
      function loadFromURL() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('q')) document.getElementById('gg-search').value = params.get('q');
        if (params.get('tier')) document.getElementById('gg-tier').value = params.get('tier');
        if (params.get('region')) document.getElementById('gg-region').value = params.get('region');
        if (params.get('distance')) document.getElementById('gg-distance').value = params.get('distance');
        if (params.get('month')) document.getElementById('gg-month').value = params.get('month');
        if (params.get('profile')) document.getElementById('gg-profile').value = params.get('profile');
        if (params.get('sort')) currentSort = params.get('sort');

        // Restore match mode from URL
        if (params.get('match') === '1') {
          SLIDERS.forEach(s => {
            const val = params.get('q_' + s.key);
            if (val) document.getElementById('gg-q-' + s.key).value = val;
          });
          // Defer runMatch until data is loaded — handled via displayMode check after data loads
          displayMode = 'match';
          document.getElementById('gg-btn-reset').style.display = '';
        }
      }

      function saveToURL() {
        const f = getFilters();
        const params = new URLSearchParams();
        if (f.search) params.set('q', f.search);
        if (f.tier) params.set('tier', f.tier);
        if (f.region) params.set('region', f.region);
        if (f.distance) params.set('distance', f.distance);
        if (f.month) params.set('month', f.month);
        if (f.profile) params.set('profile', f.profile);
        if (currentSort !== 'score') params.set('sort', currentSort);

        if (displayMode === 'match') {
          params.set('match', '1');
          SLIDERS.forEach(s => {
            const val = document.getElementById('gg-q-' + s.key).value;
            if (val !== '3') params.set('q_' + s.key, val);
          });
        }

        const newURL = params.toString()
          ? `${window.location.pathname}?${params.toString()}`
          : window.location.pathname;
        window.history.replaceState({}, '', newURL);
      }

      // ── Filter helpers ──
      function countByFilter(filterKey, filterValue) {
        return allRaces.filter(r => {
          if (filterKey === 'tier') return r.tier == filterValue;
          if (filterKey === 'region') return r.region === filterValue;
          if (filterKey === 'month') return r.month === filterValue;
          if (filterKey === 'profile') {
            if (filterValue === 'yes') return r.has_profile;
            if (filterValue === 'no') return !r.has_profile;
          }
          if (filterKey === 'distance') {
            const [min, max] = filterValue.split('-').map(Number);
            const d = r.distance_mi || 0;
            return d >= min && d <= max;
          }
          return true;
        }).length;
      }

      function populateFilterOptions() {
        const tierSel = document.getElementById('gg-tier');
        tierSel.innerHTML = '<option value="">All Tiers</option>';
        [1, 2, 3, 4].forEach(t => {
          const count = countByFilter('tier', t);
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = `Tier ${t} (${count})`;
          tierSel.appendChild(opt);
        });

        const regions = [...new Set(allRaces.map(r => r.region).filter(Boolean))].sort();
        const regionSel = document.getElementById('gg-region');
        regionSel.innerHTML = '<option value="">All Regions</option>';
        regions.forEach(r => {
          const count = countByFilter('region', r);
          const opt = document.createElement('option');
          opt.value = r; opt.textContent = `${r} (${count})`;
          regionSel.appendChild(opt);
        });

        const distSel = document.getElementById('gg-distance');
        distSel.innerHTML = '<option value="">Any Distance</option>';
        [['0-50', 'Under 50 mi'], ['50-100', '50-100 mi'], ['100-200', '100-200 mi'], ['200-999', '200+ mi']].forEach(([val, label]) => {
          const count = countByFilter('distance', val);
          const opt = document.createElement('option');
          opt.value = val; opt.textContent = `${label} (${count})`;
          distSel.appendChild(opt);
        });

        const months = ['January','February','March','April','May','June',
                        'July','August','September','October','November','December'];
        const monthSel = document.getElementById('gg-month');
        monthSel.innerHTML = '<option value="">Any Month</option>';
        months.forEach(m => {
          const count = countByFilter('month', m);
          if (count > 0) {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = `${m} (${count})`;
            monthSel.appendChild(opt);
          }
        });

        const profSel = document.getElementById('gg-profile');
        profSel.innerHTML = '<option value="">All</option>';
        const withProfile = countByFilter('profile', 'yes');
        const noProfile = countByFilter('profile', 'no');
        profSel.innerHTML += `<option value="yes">Has Profile (${withProfile})</option>`;
        profSel.innerHTML += `<option value="no">No Profile (${noProfile})</option>`;
      }

      function getFilters() {
        const search = document.getElementById('gg-search').value.toLowerCase();
        const tier = document.getElementById('gg-tier').value;
        const region = document.getElementById('gg-region').value;
        const distance = document.getElementById('gg-distance').value;
        const month = document.getElementById('gg-month').value;
        const profile = document.getElementById('gg-profile').value;
        return { search, tier, region, distance, month, profile };
      }

      function filterRaces() {
        const f = getFilters();
        return allRaces.filter(r => {
          if (f.search && !r.name.toLowerCase().includes(f.search) &&
              !(r.location || '').toLowerCase().includes(f.search)) return false;
          if (f.tier && r.tier != f.tier) return false;
          if (f.region && r.region !== f.region) return false;
          if (f.month && r.month !== f.month) return false;
          if (f.profile === 'yes' && !r.has_profile) return false;
          if (f.profile === 'no' && r.has_profile) return false;
          if (f.distance) {
            const [min, max] = f.distance.split('-').map(Number);
            const d = r.distance_mi || 0;
            if (d < min || d > max) return false;
          }
          return true;
        });
      }

      function sortRaces(races) {
        const sorted = [...races];
        switch(currentSort) {
          case 'score':
            sorted.sort((a, b) => (b.overall_score || 0) - (a.overall_score || 0));
            break;
          case 'name':
            sorted.sort((a, b) => a.name.localeCompare(b.name));
            break;
          case 'distance':
            sorted.sort((a, b) => (b.distance_mi || 0) - (a.distance_mi || 0));
            break;
        }
        return sorted;
      }

      // ── Score / rendering helpers ──
      function scoreColor(score) {
        if (score >= 85) return '#000';
        if (score >= 75) return '#333';
        if (score >= 65) return '#888';
        return '#bbb';
      }

      const SCORE_LABELS = {
        logistics: 'Logistics', length: 'Length', technicality: 'Technicality',
        elevation: 'Elevation', climate: 'Climate', altitude: 'Altitude',
        adventure: 'Adventure', prestige: 'Prestige', race_quality: 'Race Quality',
        experience: 'Experience', community: 'Community', field_depth: 'Field Depth',
        value: 'Value', expenses: 'Expenses'
      };

      function renderScoreBreakdown(scores) {
        if (!scores || Object.keys(scores).length < 7) return '';
        const rows = Object.entries(SCORE_LABELS).map(([key, label]) => {
          const val = scores[key] || 0;
          const dots = Array.from({length: 5}, (_, i) =>
            `<span class="gg-score-dot${i < val ? ' filled' : ''}"></span>`
          ).join('');
          return `<div class="gg-score-row"><span class="gg-score-row-label">${label}</span><span class="gg-score-row-dots">${dots}</span></div>`;
        }).join('');
        return `<div class="gg-score-breakdown"><div class="gg-score-grid">${rows}</div></div>`;
      }

      function renderMiniRadar(scores) {
        if (!scores || Object.keys(scores).length < 7) return '';
        const vars = ['length','technicality','elevation','climate','altitude','logistics','adventure'];
        const cx = 40, cy = 40, r = 30;
        const n = vars.length;
        const points = vars.map((v, i) => {
          const val = (scores[v] || 1) / 5;
          const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
          return [cx + r * val * Math.cos(angle), cy + r * val * Math.sin(angle)];
        });
        const poly = points.map(p => p.join(',')).join(' ');
        const grid = [0.2, 0.4, 0.6, 0.8, 1.0].map(s => {
          const gp = Array.from({length: n}, (_, i) => {
            const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            return [cx + r * s * Math.cos(angle), cy + r * s * Math.sin(angle)];
          });
          return `<polygon points="${gp.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#ddd" stroke-width="0.5"/>`;
        }).join('');
        return `<svg class="gg-radar" width="80" height="80" viewBox="0 0 80 80">
          ${grid}
          <polygon points="${poly}" fill="rgba(0,0,0,0.1)" stroke="#000" stroke-width="1.5"/>
        </svg>`;
      }

      function renderCard(race) {
        const nameTag = race.has_profile
          ? `<a class="gg-card-name" href="${race.profile_url}">${race.name}</a>`
          : `<span class="gg-card-name no-link">${race.name}</span>`;

        const breakdown = renderScoreBreakdown(race.scores);
        const scoreBar = race.overall_score
          ? `<div class="gg-score-bar" onclick="this.nextElementSibling&&this.nextElementSibling.classList.toggle('open')" title="Click for score breakdown">
              <div class="gg-score-track">
                <div class="gg-score-fill" style="width:${race.overall_score}%;background:${scoreColor(race.overall_score)}"></div>
              </div>
              <span class="gg-score-num">${race.overall_score}</span>
            </div>${breakdown}`
          : '';

        const radar = renderMiniRadar(race.scores);

        const matchBadge = (displayMode === 'match' && matchScores[race.slug] !== undefined)
          ? `<span class="gg-match-badge">${matchScores[race.slug]}% match</span>`
          : '';

        return `<div class="gg-card">
          <div class="gg-card-header">
            ${nameTag}
            <div style="display:flex;gap:6px;align-items:center">
              ${matchBadge}
              <span class="gg-tier-badge gg-tier-${race.tier}">TIER ${race.tier}</span>
            </div>
          </div>
          <div class="gg-card-meta">${race.location || 'Location TBD'}${race.month ? ' &middot; ' + race.month : ''}</div>
          <div class="gg-card-stats">
            ${race.distance_mi ? `<div class="gg-stat"><span class="gg-stat-val">${race.distance_mi}</span><span class="gg-stat-label">Miles</span></div>` : ''}
            ${race.elevation_ft ? `<div class="gg-stat"><span class="gg-stat-val">${Number(race.elevation_ft).toLocaleString()}</span><span class="gg-stat-label">Ft Elev</span></div>` : ''}
          </div>
          ${scoreBar}
          ${radar}
          ${race.tagline ? `<div class="gg-card-tagline">${race.tagline}</div>` : ''}
        </div>`;
      }

      // ── Tier grouping ──
      function groupByTier(races) {
        const groups = { 1: [], 2: [], 3: [], 4: [] };
        races.forEach(r => {
          const t = r.tier || 4;
          if (groups[t]) groups[t].push(r);
        });
        return groups;
      }

      function renderTierSections(filtered) {
        const groups = groupByTier(filtered);
        const container = document.getElementById('gg-tier-container');
        let html = '';

        [1, 2, 3, 4].forEach(t => {
          const races = groups[t];
          if (races.length === 0) return; // hide empty tiers

          const collapsed = tierCollapsed[t];
          const visible = races.slice(0, tierVisibleCounts[t]);
          const remaining = races.length - visible.length;

          html += `<div class="gg-tier-section">
            <div class="gg-tier-section-header tier-${t}" onclick="toggleTier(${t})">
              <div class="gg-tier-section-title">
                <span class="gg-tier-badge gg-tier-${t}">TIER ${t}</span>
                <h3>${TIER_NAMES[t]}</h3>
                <span class="gg-tier-section-count">${races.length} race${races.length !== 1 ? 's' : ''}</span>
              </div>
              <p class="gg-tier-section-desc">${TIER_DESCS[t]}</p>
              <span class="gg-tier-section-chevron${collapsed ? ' collapsed' : ''}">▾</span>
            </div>
            <div class="gg-tier-section-body${collapsed ? ' collapsed' : ''}">
              <div class="gg-grid">${visible.map(renderCard).join('')}</div>
              ${remaining > 0 ? `<button class="gg-load-more" onclick="loadMoreTier(${t})">Show ${Math.min(remaining, TIER_PAGE_SIZE)} more of ${remaining} remaining</button>` : ''}
            </div>
          </div>`;
        });

        if (!html) {
          html = '<div class="gg-no-results">No races match your filters.</div>';
        }
        container.innerHTML = html;
      }

      function renderMatchResults(filtered) {
        // Sort by match score descending
        const sorted = [...filtered].sort((a, b) => (matchScores[b.slug] || 0) - (matchScores[a.slug] || 0));
        const container = document.getElementById('gg-tier-container');

        let html = `<div class="gg-match-banner">
          <span>Showing results ranked by match score</span>
          <button onclick="resetMatch()">Back to Tiers</button>
        </div>`;

        if (sorted.length > 0) {
          html += `<div class="gg-grid">${sorted.map(renderCard).join('')}</div>`;
        } else {
          html += '<div class="gg-no-results">No races match your filters.</div>';
        }
        container.innerHTML = html;
      }

      function toggleTier(t) {
        tierCollapsed[t] = !tierCollapsed[t];
        render(false);
      }
      window.toggleTier = toggleTier;

      function loadMoreTier(t) {
        tierVisibleCounts[t] += TIER_PAGE_SIZE;
        render(false);
      }
      window.loadMoreTier = loadMoreTier;

      // ── Active filter pills ──
      function renderActivePills() {
        const f = getFilters();
        const container = document.getElementById('gg-active-filters');
        const pills = [];

        const filterLabels = {
          search: f.search ? `"${f.search}"` : null,
          tier: f.tier ? `Tier ${f.tier}` : null,
          region: f.region || null,
          distance: f.distance ? {
            '0-50': 'Under 50 mi',
            '50-100': '50-100 mi',
            '100-200': '100-200 mi',
            '200-999': '200+ mi'
          }[f.distance] : null,
          month: f.month || null,
          profile: f.profile ? (f.profile === 'yes' ? 'Has Profile' : 'No Profile') : null
        };

        Object.entries(filterLabels).forEach(([key, label]) => {
          if (label) {
            const inputId = key === 'search' ? 'gg-search' : `gg-${key}`;
            pills.push(`<span class="gg-filter-pill">${label}<button onclick="document.getElementById('${inputId}').value='';document.getElementById('${inputId}').dispatchEvent(new Event('change'))">×</button></span>`);
          }
        });

        if (pills.length > 1) {
          pills.push('<button class="gg-clear-all" onclick="clearAllFilters()">Clear all</button>');
        }

        container.innerHTML = pills.join('');
      }

      function clearAllFilters() {
        document.getElementById('gg-search').value = '';
        document.getElementById('gg-tier').value = '';
        document.getElementById('gg-region').value = '';
        document.getElementById('gg-distance').value = '';
        document.getElementById('gg-month').value = '';
        document.getElementById('gg-profile').value = '';
        render();
      }
      window.clearAllFilters = clearAllFilters;

      // ── Main render ──
      function render(resetPages) {
        if (resetPages !== false) {
          tierVisibleCounts = { 1: TIER_PAGE_SIZE, 2: TIER_PAGE_SIZE, 3: TIER_PAGE_SIZE, 4: TIER_PAGE_SIZE };
        }

        const filtered = sortRaces(filterRaces());

        // If match mode was loaded from URL but scores not yet computed, compute now
        if (displayMode === 'match' && Object.keys(matchScores).length === 0) {
          const vals = getSliderValues();
          allRaces.forEach(r => {
            matchScores[r.slug] = computeMatchScore(r, vals);
          });
        }

        document.getElementById('gg-count').textContent =
          `${filtered.length} race${filtered.length !== 1 ? 's' : ''} found`;

        if (displayMode === 'match') {
          renderMatchResults(filtered);
        } else {
          renderTierSections(filtered);
        }

        renderActivePills();
        saveToURL();
      }

      // ── Event binding ──
      function bindEvents() {
        ['gg-search','gg-tier','gg-region','gg-distance','gg-month','gg-profile'].forEach(id => {
          document.getElementById(id).addEventListener('input', render);
          document.getElementById(id).addEventListener('change', render);
        });

        document.querySelectorAll('.gg-sort-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.gg-sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSort = btn.dataset.sort;
            render();
          });
          if (btn.dataset.sort === currentSort) {
            document.querySelectorAll('.gg-sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</div>
